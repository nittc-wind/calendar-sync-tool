<!-- アップロード画面 -->
<div class="page-container" id="upload">
    <!-- ページタイトル -->
    <div class="page-header">
        <h1 class="page-title">Excelファイルをアップロード</h1>
        <p class="page-description">予定表のExcelファイルをアップロードしてください</p>
    </div>
    
    <!-- メインコンテンツエリア -->
    <div class="page-content">
        <!-- ここに画面固有のコンテンツを追加 -->
        
        <div class="content-section">
            <div id="drag-drop" class="drag-drop">
              <form>
                <h2>ここにファイルをドラッグ＆ドロップ</h2>
                <p>もしくは</p>
            </div>
              <input type="file" id="file-select" style="display: none;">
              <button id="file-input" class="btn btn-primary">ファイルを選択</button><br><br>
              <button id="upload-button" class="btn btn-primary" style="display:none;">アップロード</button>
              <p id="upload-status"></p>
            </form>
            <div id="result"></div>
            <div id="sheetIdArea" style="display:none; margin-top:10px;">
              <label>スプレッドシートID:</label>
              <input type="text" id="sheetIdText" readonly style="width: 300px;" />
              <button id="copySheetIdBtn" type="button">コピー</button>
            </div>
            <div id="loading" style="display: none;">アップロード中...</div>

        </div>
        <script>

          const dropArea = document.getElementById('drag-drop');
          const selectFile= document.getElementById('file-select')
          const fileInput = document.getElementById('file-input');
          const uploadBtn = document.getElementById('upload-button');
          const uploadStatus = document.getElementById('upload-status');
          if(dropArea){
              dropArea.addEventListener('dragover',(e)=>{
                  e.preventDefault();
                  dropArea.classList.add('dragover');
              });

              dropArea.addEventListener('dragleave', (e) => {
                  e.preventDefault();
                  dropArea.classList.remove('dragover');
              });

              dropArea.addEventListener('drop', (e) => {
                  e.preventDefault();
                  dropArea.classList.remove('dragover');
                  const files = e.dataTransfer.files;
                  if (files.length > 0) {
                      fileInput.files = files;
                      dropArea.textContent = `選択中: ${files[0].name}`;
                      uploadBtn.style.display = "inline-block";
                  }
              });
            fileInput.addEventListener('click',()=> selectFile.click());
            selectFile.addEventListener('change', () => {
            if (selectFile.files.length > 0) {
            dropArea.textContent = `選択中: ${selectFile.files[0].name}`;
            uploadBtn.style.display = "inline-block";
            }
            });
            document.getElementById('uploadForm').onsubmit = function(e) {
            e.preventDefault();
            const fileInput = this.file;
            if (!fileInput.files.length) return;
            const file = fileInput.files[0];
            // ローディング表示
            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').innerText = '';
            document.getElementById('sheetIdArea').style.display = 'none';
            const reader = new FileReader();
            reader.onload = function() {
              // DataURL形式でbase64化
              const dataUrl = reader.result;
              google.script.run
                .withSuccessHandler(function(id) {
                  document.getElementById('loading').style.display = 'none';
                  document.getElementById('result').innerHTML =
                    'アップロード成功: <a href="https://docs.google.com/spreadsheets/d/' + id + '" target="_blank">スプレッドシートを開く</a>';
                  document.getElementById('sheetIdText').value = id;
                  document.getElementById('sheetIdArea').style.display = 'block';
                })
                .withFailureHandler(function(err) {
                  document.getElementById('loading').style.display = 'none';
                  document.getElementById('result').innerText = 'エラー: ' + err.message;
                })
                .uploadExcelFile({ 
                  dataUrl: dataUrl, 
                  fileName: file.name, 
                  mimeType: file.type 
                });
            };
            reader.readAsDataURL(file);
          };

          document.getElementById('copySheetIdBtn').onclick = function() {
            const input = document.getElementById('sheetIdText');
            input.select();
            input.setSelectionRange(0, 99999); // for mobile
            document.execCommand('copy');
          };
        </script>
    </div>
</div>